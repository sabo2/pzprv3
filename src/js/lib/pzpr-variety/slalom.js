/*! @license pzpr.js v3.6.0-pre (c) 2009-2016 sabo2, MIT license
 *   https://bitbucket.org/sabo2/pzprv3 */
pzpr.classmgr.makeCustom(["slalom"],{MouseEvent:{redline:!0,mouseinput:function(){this.puzzle.playmode?this.btn.Left?this.mousestart||this.mousemove?this.inputLine():this.mouseend&&this.notInputted()&&this.inputpeke():this.btn.Right&&(this.mousestart||this.mousemove)&&this.inputpeke():this.puzzle.editmode&&(this.mousestart||this.mousemove?this.inputEdit():this.mouseend&&this.inputEdit_end())},inputEdit:function(){var a=this.getcell();a.isnull||(this.mouseCell.isnull&&this.inputEdit_first(a),10===this.inputData?this.board.startpos.input(a):2===this.inputData?this.inputdirec():this.inputGate(a),this.mouseCell=a)},inputEdit_first:function(a){a===this.board.startpos.getc()?this.inputData=10:1===a.ques&&a.isNum()?this.inputData=2:this.firstPoint.set(this.inputPoint)},inputGate:function(a){var b=a.getaddr(),c=!1;if(1===a.ques);else if(null===this.inputData){if(a===this.mouseCell){var d=Math.abs(this.inputPoint.bx-this.firstPoint.bx),e=Math.abs(this.inputPoint.by-this.firstPoint.by);e>=.25?(this.inputData=21,c=!0):d>=.25&&(this.inputData=22,c=!0)}else{var f=this.prevPos.getvert(b,2);void 0!==f&&(this.inputData=f?21:22,c=!0)}c&&(a.ques===this.inputData&&(this.inputData=0),this.firstPoint.reset())}else if(a!==this.mouseCell)if(0===this.inputData)this.inputData=0,c=!0;else{var f=this.prevPos.getvert(b,2);void 0!==f&&(this.inputData=f?21:22,c=!0)}if(this.prevPos=b,c){var g=this.board;a.setQues(this.inputData),g.gatemgr.rebuild(),a.draw(),g.startpos.draw()}},inputEdit_end:function(){var a=this.getcell();a.isnull||(10===this.inputData?(this.inputData=null,a.draw()):this.notInputted()&&(a!==this.cursor.getc()?this.setcursor(a):this.inputGateNumber(a)))},inputGateNumber:function(a){var b=this.board;this.btn.Left?a.setQues({0:1,1:21,21:22,22:0}[a.ques]):this.btn.Right&&a.setQues({0:22,22:21,21:1,1:0}[a.ques]),a.setNum(-1),b.gatemgr.rebuild(),a.draw(),b.startpos.draw()}},KeyEvent:{enablemake:!0,enableplay:!0,keyup_event:!0,moveTarget:function(a){return a.match(/shift/)?!1:this.puzzle.editmode&&"x"!==a?this.moveTCell(a):!1},keyinput:function(a){if("x"!==a){if(this.keydown&&this.puzzle.editmode){if(this.key_inputdirec(a))return;this.key_inputqnum_slalom(a)}}else this.puzzle.painter.drawNumbersOnGate(!!this.keydown)},key_inputqnum_slalom:function(a){var b=this.cursor.getc(),c=this.board;if("q"===a||"w"===a||"e"===a||"r"===a||"s"===a||" "===a){var d=b.ques,e=-1;if("q"===a)e=1!==d?1:0;else if("w"===a)e=21;else if("e"===a)e=22;else if("r"===a||" "===a)e=0;else{if("s"!==a)return;c.startpos.input(b)}if(d===e)return;-1!==e&&(b.setQues(e),0===e&&b.setNum(-1),(21===d||22===d||21===e||22===e)&&c.gatemgr.rebuild(),b.draw(),c.startpos.draw())}else 1===b.ques&&this.key_inputqnum(a)}},Cell:{disInputHatena:!0,maxnum:function(){return Math.min(255,this.board.gatemgr.components.length)},gate:null,getConnectingGate:function(){var a,b=this.adjacent,c=[];return a=b.top,a.isnull||21!==a.ques||c.push(a.gate),a=b.bottom,a.isnull||21!==a.ques||c.push(a.gate),a=b.left,a.isnull||22!==a.ques||c.push(a.gate),a=b.right,a.isnull||22!==a.ques||c.push(a.gate),c}},Border:{enableLineNG:!0},Board:{hasborder:1,startpos:null,gatemgr:null,gates:null,initialize:function(){this.common.initialize.call(this),this.startpos=new this.klass.StartPosAddress(1,1),this.gatemgr=this.addInfoList(this.klass.AreaHurdleGraph)},initBoardSize:function(a,b){this.common.initBoardSize.call(this,a,b),this.startpos.set(this.cell[0]),this.gatemgr.init()}},BoardExec:{posinfo:{},adjustBoardData:function(a,b){var c=this.board;if(a&this.TURN)for(var d={21:22,22:21},e=c.cellinside(b.x1,b.y1,b.x2,b.y2),f=0;f<e.length;f++){var g=e[f],h=d[g.ques];h&&g.setQues(h)}this.posinfo=this.getAfterPos(a,b,c.startpos.getc()),this.adjustNumberArrow(a,b)},adjustBoardData2:function(a,b){var c,d=this.board,e=this.puzzle.opemgr,f=this.posinfo;c=a&this.REDUCE&&f.isdel&&!e.undoExec&&!e.redoExec,c&&(e.forceRecord=!0),d.startpos.set(f.pos.getc()),c&&(e.forceRecord=!1),d.gatemgr.rebuild()}},"StartPosAddress:Address":{input:function(a){var b=this.clone();this.equals(a)||(this.set(a),b.draw()),this.draw()},set:function(a){this.addOpe(a.bx,a.by),this.bx=a.bx,this.by=a.by},addOpe:function(a,b){!this.puzzle.ready||this.bx===a&&this.by===b||this.puzzle.opemgr.add(new this.klass.StartposOperation(this.bx,this.by,a,b))}},"StartposOperation:Operation":{setData:function(a,b,c,d){this.bx1=a,this.by1=b,this.bx2=c,this.by2=d},decode:function(a){return"PS"!==a[0]?!1:(this.bx1=+a[1],this.by1=+a[2],this.bx2=+a[3],this.by2=+a[4],!0)},toString:function(){return["PS",this.bx1,this.by1,this.bx2,this.by2].join(",")},isModify:function(a){return this.manager.changeflag&&a.bx2===this.bx1&&a.by2===this.by1?(a.bx2=this.bx2,a.by2=this.by2,!0):!1},undo:function(){this.exec(this.bx1,this.by1)},redo:function(){this.exec(this.bx2,this.by2)},exec:function(a,b){var c=this.board,d=c.getc(a,b);c.startpos.input(d)}},OperationManager:{initialize:function(){this.common.initialize.call(this),this.operationlist.push(this.klass.StartposOperation)}},LineGraph:{enabled:!0},"AreaHurdleGraph:AreaGraphBase":{enabled:!0,setComponentRefs:function(a,b){a.gate=b},getObjNodeList:function(a){return a.gatenodes},resetObjNodeList:function(a){a.gatenodes=[]},isnodevalid:function(a){return 21===a.ques||22===a.ques},isedgevalidbynodeobj:function(a,b){var c=a.getdir(b,2);return c===a.UP||c===a.DN?21===a.ques&&21===b.ques:c===a.LT||c===a.RT?22===a.ques&&22===b.ques:!1},rebuild:function(){this.klass.AreaGraphBase.prototype.rebuild.call(this),this.generateGateNumberAll()},remakeComponent:function(){this.klass.AreaGraphBase.prototype.remakeComponent.call(this),this.generateGateNumberAll()},resetExtraData:function(a){a.gate=null},setExtraData:function(a){a.clist=new this.klass.CellList(a.getnodeobjs()),a.vert=21===a.clist[0].ques,a.number=-1},generateGateNumberAll:function(){function a(a){for(var b=0;b<c.length;b++){for(var d=[],e=c[b].nums,f=0;f<e.length;f++)1!==a[e[f]]&&d.push(e[f]);e[b]=d}}for(var b=this.board,c=this.components,d=0;d<c.length;d++)c[d].number=-1;for(var d=0;d<c.length;d++)c[d].nums=[];for(var e=0;e<b.cell.length;e++){var f=b.cell[e];if(1===f.ques){var g=f.getNum(),h=f.qdir,i=f.adjacent;if(0>=g||g>=c.length)continue;h!==f.NDIR&&h!==f.UP||21!==i.top.ques||i.top.gate.nums.push(g),h!==f.NDIR&&h!==f.DN||21!==i.bottom.ques||i.bottom.gate.nums.push(g),h!==f.NDIR&&h!==f.LT||22!==i.left.ques||i.left.gate.nums.push(g),h!==f.NDIR&&h!==f.RT||22!==i.right.ques||i.right.gate.nums.push(g)}}for(var j=[],k=0;k<c.length;k++)j[k]=0;for(var d=0;d<c.length;d++){var l=c[d],m=l.nums;2===m.length&&m[0]>0&&m[0]===m[1]&&(l.number=m[0],j[m[0]]=1,l.nums=[])}a(j);for(var n=!0;n;){n=!1;for(var k=0;k<c.length;k++)j[k]=0;for(var o=[],k=0;k<c.length;k++)o[k]=0;for(var d=0;d<c.length;d++){var m=c[d].nums;1===m.length&&o[m[0]]++}for(var d=0;d<c.length;d++){var l=c[d],m=l.nums,p=1===m.length?m[0]:-1;p>0&&o[p]>1&&(p=-1),p>0&&(l.number=p,j[p]=1,l.nums=[],n=!0)}if(a(j),!n){for(var k=0;k<c.length;k++)o[k]=0;for(var d=0;d<c.length;d++)for(var m=c[d].nums,q=0;q<m.length;q++)o[m[q]]++;for(var d=0;d<c.length;d++){for(var l=c[d],m=l.nums,p=-1,q=0;q<m.length;q++)1===o[m[q]]&&(p=-1===p?m[q]:-1);p>0&&(l.number=p,j[p]=1,l.nums=[],n=!0)}a(j)}}for(var d=0;d<c.length;d++)c[d].nums=null},setGateError:function(a,b){var c,d,e=this.board,f=new this.klass.CellList,g=a.clist.getRectSize();a.vert?(c=e.getc(g.x1,g.y1-2),d=e.getc(g.x1,g.y2+2)):(c=e.getc(g.x1-2,g.y1),d=e.getc(g.x2+2,g.y1)),c.isnull||1!==c.ques||f.add(c),d.isnull||1!==d.ques||f.add(d),f.seterr(b)}},Graphic:{irowake:!0,gridcolor_type:"LIGHT",errbcolor1_type:"DARK",fontcolor:"white",fontErrcolor:"white",linecolor:"rgb(32, 32, 255)",errlinebgcolor:"rgb(160, 150, 255)",pekecolor:"rgb(0, 160, 0)",paint:function(){this.drawBGCells(),this.drawGrid(),this.drawGates(),this.drawShadedCells(),this.drawArrowNumbers(),this.drawPekes(),this.drawLines(),this.drawStartpos(),this.drawChassis(),this.drawTarget()},getCellColor:function(a){if(1===a.ques){if(0===a.error)return this.quescolor;if(1===a.error)return this.errcolor1}return null},drawGates:function(){for(var a=this.vinc("cell_gate","auto",!0),b=Math.max(this.cw/10,3),c=b/2,d=1.1*b,e=this.range.cells,f=0;f<e.length;f++){var g=e[f];if(a.fillStyle=4===g.error?this.errcolor1:this.quescolor,a.vid="c_dl21_"+g.id,21===g.ques){var h,i=g.bx*this.bw-c+1,j=(g.by-1)*this.bh,k=j+this.ch;for(a.beginPath(),h=j;k>h;h+=2*d)a.rect(i,h,b,d);a.fill()}else a.vhide();if(a.vid="c_dl22_"+g.id,22===g.ques){var i,h=g.by*this.bh-c+1,l=(g.bx-1)*this.bw,k=l+this.cw;for(a.beginPath(),i=l;k>i;i+=2*d)a.rect(i,h,d,b);a.fill()}else a.vhide()}},drawStartpos:function(){var a=this.vinc("cell_circle","auto"),b=this.board,c=b.startpos.getc(),d=this.range;if(!(c.bx<d.x1||d.x2<c.bx||c.by<d.y1||d.y2<c.by)){var e=c.bx*this.bw,f=c.by*this.bh,g=.42*this.cw;a.vid="c_stpos",a.lineWidth=Math.max(.05*this.cw,1),a.strokeStyle=this.quescolor,a.fillStyle=10===this.puzzle.mouse.inputData?this.errbcolor1:"white",a.shapeCircle(e,f,g),a.vid="text_stpos",a.fillStyle=this.quescolor,this.disptext(""+b.gatemgr.components.length,e,f,{ratio:[.75,.66]})}},repaintParts:function(a){for(var b=a.cellinside(),c=0;c<b.length;c++){var d=b[c];if(this.board.startpos.equals(d)){this.range={x1:d.bx,y1:d.by,x2:d.bx,y2:d.by},this.drawStartpos();break}}},drawNumbersOnGate:function(a){var b=this.context,c=this.board;a&&c.gatemgr.generateGateNumberAll();for(var d=0;d<c.cell.length;d++){var e=c.cell[d];if(21===e.ques||22===e.ques){var f=e.gate.number;b.vid="cell_text_"+d,a&&f>0?(b.fillStyle="tomato",this.disptext(""+f,e.bx*this.bw,e.by*this.bh)):b.vhide()}}}},Encode:{decodePzpr:function(a){this.decodeSlalom(this.checkpflag("d")?2:this.checkpflag("p")?1:0)},encodePzpr:function(a){var b=pzpr.parser;return a===b.URL_PZPRV3&&(this.outpflag="d"),this.encodeSlalom(a===b.URL_PZPRV3?2:0)},decodeKanpen:function(){this.puzzle.fio.decodeBoard_kanpen()},encodeKanpen:function(){this.puzzle.fio.encodeBoard_kanpen()},decodeSlalom:function(a){var b=this.outbstr,c=b.split("/"),d=0,e=0,f=this.board;for(e=0;e<c[0].length;e++){var g=c[0].charAt(e),h=f.cell[d];if("1"===g?h.ques=1:"2"===g?h.ques=21:"3"===g?h.ques=22:(this.include(g,"4","9")||this.include(g,"a","z"))&&(d+=parseInt(g,36)-4),d++,!f.cell[d])break}if(f.gatemgr.rebuild(),0===a){var i=0;for(e+=1;e<c[0].length;e++){var g=c[0].charAt(e);if(this.include(g,"0","9")||this.include(g,"a","f")?f.gatemgr.components[i].number=parseInt(g,16):"-"===g?(f.gatemgr.components[i].number=parseInt(b.substr(e+1,2),16),e+=2):this.include(g,"g","z")&&(i+=parseInt(g,36)-16),i++,i>f.gatemgr.components.length)break}for(var d=0;d<f.cell.length;d++){for(var j=f.cell[d].getConnectingGate(),k=1e3,e=0;e<j.length;e++){var l=j[e].number;l>0&&(k=Math.min(k,l))}f.cell[d].qnum=1e3>k?k:-1}}else if(1===a||2===a){var d=0,m=0;for(e+=1;e<c[0].length;e++){var h=f.cell[d];if(1!==h.ques)e--;else if(m>0)e--,m--;else{var g=c[0].charAt(e);1===a&&(this.include(g,"0","9")||this.include(g,"a","f"))?h.qnum=parseInt(g,16):1===a&&"-"===g?(h.qnum=parseInt(b.substr(e+1,2),16),e+=2):2===a&&this.include(g,"0","4")?(h.qdir=parseInt(g,16),h.qnum=parseInt(b.charAt(e+1),16),e++):2===a&&this.include(g,"5","9")?(h.qdir=parseInt(g,16)-5,h.qnum=parseInt(b.substr(e+1,2),16),e+=2):g>="g"&&"z">=g&&(m=parseInt(g,36)-15-1)}if(d++,!f.cell[d])break}}f.startpos.set(f.cell[+c[1]]),this.outbstr=c[0].substr(e)},encodeSlalom:function(a){for(var b="",c=0,d=this.board,e=0;e<d.cell.length;e++){var f="",g=d.cell[e];1===g.ques?f="1":21===g.ques?f="2":22===g.ques?f="3":c++,0===c?b+=f:(f||32===c)&&(b+=(3+c).toString(36)+f,c=0)}if(c>0&&(b+=(3+c).toString(36)),c=0,0===a){for(var h=0;h<d.gatemgr.components.length;h++){var f="",i=d.gatemgr.components[h].number;i>=0&&16>i?f=i.toString(16):i>=16&&256>i?f="-"+i.toString(16):c++,0===c?b+=f:(f||20===c)&&(b+=(15+c).toString(36)+f,c=0)}c>0&&(b+=(15+c).toString(36))}else if(1===a||2===a){for(var e=0;e<d.cell.length;e++){var g=d.cell[e];if(1===g.ques){var f="",i=g.qnum,j=g.qdir;i>=1&&16>i?f=(1===a?"":""+j)+i.toString(16):i>=16&&256>i?f=(1===a?"-":""+(j+5))+i.toString(16):c++,0===c?b+=f:(f||20===c)&&(b+=(15+c).toString(36)+f,c=0)}}c>0&&(b+=(15+c).toString(36))}b+="/"+d.startpos.getc().id,this.outbstr+=b}},FileIO:{decodeData:function(){2===this.filever?this.decodeBoard_pzpr2():1===this.filever?this.decodeBoard_pzpr1():0===this.filever&&this.decodeBoard_old(),this.decodeBorderLine()},encodeData:function(){this.filever=2,this.encodeBoard_pzpr2(),this.encodeBorderLine()},kanpenOpen:function(){this.decodeBoard_kanpen(),this.decodeBorderLine()},kanpenSave:function(){this.encodeBoard_kanpen(),this.encodeBorderLine()},decodeBoard_pzpr1:function(){var a=this.board;this.decodeCell(function(b,c){"o"===c?a.startpos.set(b):"i"===c?b.ques=21:"-"===c?b.ques=22:"#"===c?b.ques=1:"."!==c&&(b.ques=1,b.qnum=+c)}),a.gatemgr.rebuild()},decodeBoard_pzpr2:function(){var a=this.board;this.decodeCell(function(b,c){if("o"===c)a.startpos.set(b);else if("i"===c)b.ques=21;else if("-"===c)b.ques=22;else if("#"===c)b.ques=1;else if("."!==c){var d=c.split(",");b.ques=1,b.qdir="0"!==d[0]?+d[0]:0,b.qnum="-"!==d[1]?+d[1]:-2}}),a.gatemgr.rebuild()},encodeBoard_pzpr2:function(){var a=this.board;this.encodeCell(function(b){if(a.startpos.equals(b))return"o ";if(21===b.ques)return"i ";if(22===b.ques)return"- ";if(1===b.ques&&b.qnum<=0)return"# ";if(1===b.ques){var c=0!==b.qdir?""+b.qdir:"0",d=-2!==b.qnum?""+b.qnum:"-";return[c,",",d," "].join("")}return". "})},decodeBoard_kanpen:function(){var a=this.board;this.decodeCell(function(b,c){"+"===c?a.startpos.set(b):"|"===c?b.ques=21:"-"===c?b.ques=22:"0"===c?b.ques=1:"."!==c&&(b.ques=1,b.qnum=+c)}),a.gatemgr.rebuild()},encodeBoard_kanpen:function(){var a=this.board;this.encodeCell(function(b){return a.startpos.equals(b)?"+ ":21===b.ques?"| ":22===b.ques?"- ":1===b.ques?b.qnum>0?b.qnum+" ":"0 ":". "})},kanpenOpenXML:function(){this.decodeCellSlalom_XMLBoard(),this.decodeBorderLine_XMLAnswer()},kanpenSaveXML:function(){this.encodeCellSlalom_XMLBoard(),this.encodeBorderLine_XMLAnswer()},UNDECIDED_NUM_XML:-3,decodeCellSlalom_XMLBoard:function(){var a=this.board;this.decodeCellXMLBoard(function(b,c){c>=0?(b.ques=1,c>0&&(b.qnum=c)):-5===c?b.ques=21:-4===c?b.ques=22:-1===c&&a.startpos.set(b)}),a.gatemgr.rebuild()},encodeCellSlalom_XMLBoard:function(){var a=this.board;this.encodeCellXMLBoard(function(b){var c=-3;return 1===b.ques?c=b.qnum>0?b.qnum:0:21===b.ques?c=-5:22===b.ques?c=-4:a.startpos.equals(b)&&(c=-1),c})},decodeBoard_old:function(){var a=[],b=this.board;this.decodeCell(function(c,d){var e=c.id;a[e]=-1,"#"===d?c.ques=1:"o"===d?b.startpos.set(c):"."!==d&&("i"===d.charAt(0)?c.ques=21:"w"===d.charAt(0)&&(c.ques=22),d.length>1&&(a[e]=+d.substr(1)))}),b.gatemgr.rebuild();for(var c=0;c<b.cell.length;c++)-1!==a[c]&&(b.cell[c].gate.number=a[c]);for(var c=0;c<b.cell.length;c++){for(var d=b.cell[c].getConnectingGate(),e=1e3,f=0;f<d.length;f++){var g=d[f].number;g>0&&(e=Math.min(e,g))}b.cell[c].qnum=1e3>e?e:-1}}},AnsCheck:{checklist:["checkLineOnShadeCell","checkCrossLine","checkBranchLine","checkPassGateOnce","checkStartid","checkGateNumber","checkDeadendLine+","checkOneLoop","checkPassAllGate"],checkStartid:function(){var a=this.board.startpos.getc();2!==a.lcnt&&(a.seterr(1),this.failcode.add("stLineNe2"))},checkPassGateOnce:function(){return this.checkGateLine(1,"gateRedup")},checkPassAllGate:function(){return this.checkGateLine(2,"gateUnpass")},checkGateLine:function(a,b){for(var c=this.board,d=c.gatemgr.components,e=0;e<d.length;e++){for(var f=0,g=d[e].clist,h=0;h<g.length;h++)g[h].lcnt>0&&f++;if(!(1===a&&1>=f||2===a&&f>0)){if(this.failcode.add(b),this.checkOnly)break;g.seterr(4),c.gatemgr.setGateError(d[e],1)}}},checkGateNumber:function(){var a=this.getTraceInfo();null!==a&&(this.failcode.add("lrOrder"),a.clist.seterr(4),this.board.gatemgr.setGateError(a,1))},getTraceInfo:function(){return this.searchTraceInfo(this.board.startpos.getc())},searchTraceInfo:function(a){if(0===a.lcnt)return null;for(var b=null,c=a.getdir(a.pathnodes[0].nodes[0].obj,2),d=a.getaddr(),e=0,f=-1,g=this.board.gatemgr.components.length;;)if(d.movedir(c,1),d.oncell()){var h=d.getc();if(a===h)break;if(21===h.ques||22===h.ques){var i=h.gate;e++;var j=i.number;if(0>=j);else if(-1===f){var k=g+1-j;if(j===k);else{if(e!==j){if(e===k)break;b=i;break}f=1}}else if(1===f&&e!==j){b=i;break}}var l=h.adjborder;if(2!==h.lcnt)break;1!==c&&l.bottom.isLine()?c=2:2!==c&&l.top.isLine()?c=1:3!==c&&l.right.isLine()?c=4:4!==c&&l.left.isLine()&&(c=3)}else if(!d.getb().isLine())break;return b}},FailCode:{gateRedup:["線が２回以上通過している旗門があります。","A line goes through a gate twice or more."],gateUnpass:["線が通過していない旗門があります。","There is a gate that the line is not passing."],lrOrder:["旗門を通過する順番が間違っています。","The order of passing the gate is wrong."],stLineNe2:["○から線が２本出ていません。","A line goes through a gate twice or more."]}});